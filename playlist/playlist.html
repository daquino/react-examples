<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>untitled</title>
        <link rel="stylesheet" media="screen" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"/>
        <script src="http://fb.me/react-0.13.3.js"></script>
        <script src="http://fb.me/JSXTransformer-0.13.3.js"></script>
        <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    </head>
    <body>
        <script type="text/jsx">
            /** @jsx React.DOM */
            var App = React.createClass({
              search: function(searchTerm) {
                $.ajax({
                  url: 'https://api.spotify.com/v1/search',
                  data: {
                    q: searchTerm,
                    type: 'track',
                    limit: 10
                  },
                  success: function (resp) {
                    var results = resp.tracks.items.map(function(result, i) {
                      var images = result.album.images;
                      return {
                        title: result.name,
                        url: result.preview_url,
                        playing: false,
                        image: images[images.length-1].url,
                        uri: result.uri
                      };
                    });
                    this.setState({results: results});
                    var found = false;
                    for(var i=0; i < this.state.songs.length; i++) {
                      var song = this.state.songs[i];
                      if(song.playing) {
                        found = true;
                        break;
                      }
                    }
                    if(!found) {
                      this.state.player.pause();
                    }
                  }.bind(this)
                });
              },
              updateCurrentSong: function(index, list, playing) {
                this.state.songs.forEach(function(song) {
                  song.playing = false;
                });
                this.state.results.forEach(function(result) {
                  result.playing = false;
                });
                var list = this.state[list];
                list[index].playing = playing;
                var newState = {};
                newState[list] = list;
                this.setState(newState);
              },
              addSong: function(index) {
                var result = this.state.results[index];
                var songs = this.state.songs;
                songs.push({
                  title: result.title,
                  url: result.url,
                  playing: false,
                  image: result.image,
                  uri: result.uri
                });
                this.setState({songs: songs});
              },
              isInPlaylist: function(uri) {
                var found = false;
                var songs = this.state.songs;
                for(var i = 0; i < songs.length; i++) {
                  var song = songs[i];
                  if (song.uri === uri) {
                    found = true;
                    break;
                  }
                }
                return found;
              },
              removeSong: function(index) {
                var songs = this.state.songs;
                songs.splice(index, 1);
                this.setState({songs: songs});
              },
              clearResults: function() {
                this.setState({results: []});
              },
              getInitialState: function() {
                return {
                  player: document.createElement('audio'),
                  songs : [],
                  results: [],
                };
              },
              render: function() {
                return (
                  <div className="container">
                    <div className="row">
                      <div className="col-md-4">
                        <h1>Current playlist</h1>
                        <Playlist player={this.state.player} songs={this.state.songs} updateCurrentSong={this.updateCurrentSong} removeSong={this.removeSong} />
                      </div>
                      <div className="col-md-8">
                        <h1>Search</h1>
                        <Search player={this.state.player} search={this.search} results={this.state.results} updateCurrentSong={this.updateCurrentSong} addSong={this.addSong} clearResults={this.clearResults} isInPlaylist={this.isInPlaylist}/>
                      </div>
                    </div>
                  </div>
                );
              }

            });

            var Playlist = React.createClass({
              render: function() {
                var songs = this.props.songs.map(function(item, i) {
                  var updateSong = function(playing) {
                    this.props.updateCurrentSong(i, 'songs', playing);
                  }.bind(this);
                  var props = {
                    key: i,
                    index: i,
                    item: item,
                    player: this.props.player,
                    updateCurrentSong: updateSong,
                    removeSong: this.props.removeSong
                  };
                  return <Song {...props}/>
                }, this);
                return (
                    <div>
                      {songs}
                    </div>
                );
              }
            });

            var Song = React.createClass({
              toggleSong: function() {
                var player = this.props.player;
                if(this.props.item.playing == false) {
                  player.pause();
                  player.src = this.props.item.url;
                  player.play();
                  this.props.updateCurrentSong(true);
                }
                else {
                  player.pause();
                  this.props.updateCurrentSong(false);
                }
              },
              addSong: function() {
                var index = this.props.index;
                this.props.addSong(index);
              },
              removeSong: function() {
                var index = this.props.index;
                this.props.removeSong(index);
              },
              audioButton: function() {
                var audioButton;
                if(!this.props.item.playing) {
                  audioButton = <button className='btn btn-primary btn-sm' onClick={this.toggleSong}><span className="glyphicon glyphicon-play" aria-hidden="true"></span></button>
                }
                else {
                  audioButton = <button className='btn btn-danger btn-sm' onClick={this.toggleSong}><span className="glyphicon glyphicon-stop" aria-hidden="true"></span></button>
                }
                return audioButton;
              },
              actionButton: function() {
                var actionButton;
                if(this.props.addSong) {
                  actionButton = <button className="btn btn-success btn-sm" onClick={this.addSong}><span className="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                }
                else if(this.props.removeSong) {
                  actionButton = <button className="btn btn-danger btn-sm" onClick={this.removeSong}><span className="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                }
                return actionButton;
              },
              render: function() {
                var rowStyle = {marginTop: '10px'};
                return (
                  <div className="row" style={rowStyle}>
                    <div className="col-md-12">
                        <img src={this.props.item.image} />
                        {this.props.item.title} &nbsp;
                        {this.audioButton()}
                        &nbsp;
                        {this.actionButton()}
                    </div>
                  </div>
                );
              }

            });

            var Search = React.createClass({
              search: function(e) {
                e.preventDefault();
                var searchTerm = React.findDOMNode(this.refs.searchTerm).value;
                this.props.search(searchTerm);
              },
              buildClearResultsButton: function() {
                var clearResultsButton;
                if(this.props.results.length > 0) {
                  clearResultsButton = <button className="btn btn-warning" onClick={this.clearResults}>Clear</button>
                }
                return clearResultsButton;
              },
              clearResults: function() {
                React.findDOMNode(this.refs.searchTerm).value = '';
                this.props.clearResults();
              },
              render: function() {
                var results = this.props.results.map(function(item, i) {
                  var updateSong = function(playing) {
                    this.props.updateCurrentSong(i, 'results', playing);
                  }.bind(this);
                  if(!this.props.isInPlaylist(item.uri)) {
                    var props = {
                      key: i,
                      index: i,
                      item: item,
                      player: this.props.player,
                      updateCurrentSong: updateSong,
                      addSong: this.props.addSong
                    }
                    return <Song {...props} />
                  }
                  else {
                    return null;
                  }
                }, this);
                return (
                  <div>
                    <form className="form-inline">
                      <div className="form-group">
                        <label className="sr-only">Search tracks</label>
                        <input className="form-control" type="text" ref="searchTerm" placeholder="Search tracks"/>
                      </div>
                      <button className="btn btn-info" onClick={this.search}>Search</button>
                      {this.buildClearResultsButton()}
                    </form>
                    <div id="results">
                      {results}
                    </div>
                  </div>
                );
              }
            });

            React.render(
              <App />,
              document.body
            )
        </script>
    </body>
</html>
